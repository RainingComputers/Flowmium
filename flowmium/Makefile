.PHONY: down up test watch

down:
	docker-compose -f test-services.yaml down

up: 
	docker-compose -f test-services.yaml up

test:
	mkdir -p target

	# Run sqlx migrations
	sqlx migrate run


	# TODO: Add argument to use source else pull init container from upstream by default
	# Build executable and package into a docker image
	RUSTFLAGS="-C target-feature=+crt-static" cargo build --target `uname -m`-unknown-linux-gnu
	docker build . -f test-dockerfile -t flowmium-debug --build-arg="TARGET_TRIPLE=`uname -m`-unknown-linux-gnu"

	# Push the docker image with static executble into the registry in test services
	docker tag flowmium-debug localhost:5000/flowmium-debug:latest
	docker push localhost:5000/flowmium-debug:latest

	# Run tests, kubeconfig.yaml is generated by k3s in test services
	KUBECONFIG=./kubeconfig.yaml cargo test

watch:
	KUBECONFIG=./kubeconfig.yaml watch kubectl get pods
