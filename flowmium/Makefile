down:
	docker-compose -f test-services.yaml down

test:
	mkdir -p target

	# Build executable and package into a docker image
	cargo build
	docker build . -f test-dockerfile -t flowmium-debug

	# Start test services with k3s cluster and a container registry
	docker-compose -f test-services.yaml up -d

	# Push the docker image with static executble into the registry in test services
	docker tag flowmium-debug localhost:5000/flowmium-debug:latest
	docker push localhost:5000/flowmium-debug:latest

	# Run tests, kubeconfig.yaml is generated by k3s in test services
	KUBECONFIG=./kubeconfig.yaml cargo test

watch:
	KUBECONFIG=./kubeconfig.yaml watch kubectl get pods
